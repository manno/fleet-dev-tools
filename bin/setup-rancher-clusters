#!/bin/bash

set -euxo pipefail

if [ ! -d ./.github/scripts ]; then
  echo "please change the current directory to the fleet repo checkout"
  exit 1
fi

url="${url-172.18.0.1.omg.howdoi.website}"
upstream_ctx="${FLEET_E2E_CLUSTER-k3d-upstream}"
downstream_ctx="${FLEET_E2E_CLUSTER_DOWNSTREAM-k3d-downstream}"

export cluster="$upstream_ctx"
helm repo update
./.github/scripts/setup-latest-rancher.sh "$url"

# helm upgrade --install rancher rancher-latest/rancher --version 2.6.6 \
#   --create-namespace  --namespace cattle-system \
#   --set hostname=10.4.4.40.omg.howdoi.website \
#   --set bootstrapPassword=admin

kubectl config use-context "$cluster"
./.github/scripts/wait-for-loadbalancer.sh

export cluster_downstream="$downstream_ctx"
./.github/scripts/register-downstream-clusters.sh "$url"

kubectl config use-context "$cluster"
./.github/scripts/label-downstream-cluster.sh
